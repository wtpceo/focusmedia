<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>엘리베이터TV 설치현황</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            background: #f5f5f5;
        }

        /* 헤더 */
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 56px;
            background: #fff;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 1000;
            gap: 12px;
        }
        .header h1 {
            font-size: 17px;
            font-weight: 600;
            color: #1a1a1a;
            flex: 1;
            letter-spacing: -0.3px;
        }
        .header-btn {
            width: 40px; height: 40px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .header-btn:hover { background: #f5f5f5; }
        .header-btn:active { background: #eee; }
        .header-btn svg { width: 22px; height: 22px; color: #333; }

        /* 검색바 */
        .search-bar {
            position: fixed;
            top: 64px; left: 12px; right: 12px;
            z-index: 1000;
        }
        .search-input {
            width: 100%;
            height: 46px;
            padding: 0 44px;
            border: none;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            font-size: 15px;
            outline: none;
            transition: box-shadow 0.2s;
        }
        .search-input:focus { box-shadow: 0 2px 12px rgba(0,0,0,0.18); }
        .search-input::placeholder { color: #999; }
        .search-icon, .search-clear {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-icon { left: 14px; color: #999; }
        .search-icon svg { width: 20px; height: 20px; }
        .search-clear {
            right: 8px;
            width: 32px; height: 32px;
            border: none;
            background: #eee;
            border-radius: 50%;
            cursor: pointer;
            display: none;
        }
        .search-clear.show { display: flex; }
        .search-clear svg { width: 16px; height: 16px; color: #666; }

        /* 지도 */
        #map {
            width: 100%;
            height: 100vh;
            height: 100dvh;
        }

        /* 필터 패널 */
        .filter-panel {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            max-height: 75vh;
            overflow-y: auto;
        }
        .filter-panel.open { transform: translateY(0); }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            position: sticky; top: 0;
            background: #fff;
            z-index: 1;
        }
        .filter-header h2 { font-size: 17px; font-weight: 600; }
        .filter-reset {
            font-size: 14px;
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
        }
        .filter-reset:hover { background: #f5f5f5; }
        .filter-close {
            width: 32px; height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        .filter-close svg { width: 18px; height: 18px; color: #666; }
        .filter-section {
            padding: 16px 20px;
            border-bottom: 1px solid #f5f5f5;
        }
        .filter-section h3 {
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .filter-chip {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
            color: #555;
        }
        .filter-chip:hover { border-color: #ccc; background: #fafafa; }
        .filter-chip.active {
            background: #FEE500;
            color: #000;
            border-color: #FEE500;
            font-weight: 500;
        }
        .filter-actions {
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            display: flex;
            gap: 10px;
        }
        .filter-apply {
            flex: 1;
            padding: 15px;
            background: #FEE500;
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .filter-apply:hover { background: #fdd835; }
        .filter-apply:active { background: #fbc02d; }

        /* 정보 패널 */
        .info-panel {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-height: 70vh;
            overflow-y: auto;
        }
        .info-panel.open { transform: translateY(0); }
        .info-handle {
            width: 36px; height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 12px auto 0;
        }
        .info-content {
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }
        .info-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
        }
        .info-name {
            font-size: 19px;
            font-weight: 700;
            color: #1a1a1a;
            flex: 1;
            line-height: 1.3;
        }
        .info-grade-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .info-grade-badge.s-plus { background: #7c3aed; color: #fff; }
        .info-grade-badge.s { background: #a855f7; color: #fff; }
        .info-grade-badge.a-plus { background: #ef4444; color: #fff; }
        .info-grade-badge.a { background: #3b82f6; color: #fff; }
        .info-grade-badge.b { background: #22c55e; color: #fff; }
        .info-address {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .info-item {
            background: #f8f9fa;
            padding: 12px 10px;
            border-radius: 10px;
            text-align: center;
        }
        .info-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .info-value {
            font-size: 14px;
            font-weight: 700;
            color: #1a1a1a;
        }
        .info-actions { display: flex; gap: 10px; }
        .info-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .info-btn svg { width: 18px; height: 18px; }
        .info-btn.primary { background: #FEE500; color: #000; }
        .info-btn.primary:hover { background: #fdd835; }
        .info-btn.secondary { background: #f0f0f0; color: #333; }
        .info-btn.secondary:hover { background: #e5e5e5; }

        /* 오버레이 */
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 999;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        /* 플로팅 버튼 */
        .floating-btns {
            position: fixed;
            right: 16px; bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 500;
        }
        .float-btn {
            width: 48px; height: 48px;
            background: #fff;
            border: none;
            border-radius: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .float-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,0.2); }
        .float-btn:active { transform: translateY(0); }
        .float-btn svg { width: 22px; height: 22px; color: #333; }
        .float-btn.active { background: #FEE500; }

        /* 통계 배지 */
        .stats-badge {
            position: fixed;
            left: 16px; bottom: 100px;
            background: #fff;
            padding: 10px 16px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.12);
            font-size: 13px;
            z-index: 500;
            font-weight: 500;
            color: #555;
        }
        .stats-badge strong { color: #3b82f6; font-weight: 700; }

        /* 로딩 */
        .loading {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 28px 36px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 2000;
        }
        .loading.hidden { display: none; }
        .loading-spinner {
            width: 36px; height: 36px;
            border: 3px solid #f0f0f0;
            border-top-color: #FEE500;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 14px;
        }
        .loading-text { font-size: 14px; color: #666; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 리스트 뷰 */
        .list-view {
            position: fixed;
            top: 122px; left: 12px; right: 12px; bottom: 90px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            overflow-y: auto;
            z-index: 800;
            display: none;
            flex-direction: column;
        }
        .list-view.active { display: flex; }
        .list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 1;
            flex-shrink: 0;
        }
        .list-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a1a;
        }
        .list-close {
            width: 32px; height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        .list-close:hover { background: #eee; }
        .list-close svg { width: 18px; height: 18px; color: #666; }
        .list-content {
            flex: 1;
            overflow-y: auto;
        }
        .list-item {
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.15s;
        }
        .list-item:hover { background: #fafafa; }
        .list-item:active { background: #f5f5f5; }
        .list-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .list-item-name {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a1a;
            flex: 1;
        }
        .list-item-address {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .list-item-info {
            display: flex;
            gap: 16px;
            font-size: 13px;
        }
        .list-item-info span { color: #888; }
        .list-item-info strong { color: #333; font-weight: 600; }
        .grade-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }
        .grade-badge.s-plus { background: #7c3aed; color: #fff; }
        .grade-badge.s { background: #a855f7; color: #fff; }
        .grade-badge.a-plus { background: #ef4444; color: #fff; }
        .grade-badge.a { background: #3b82f6; color: #fff; }
        .grade-badge.b { background: #22c55e; color: #fff; }

        /* 토스트 */
        .toast {
            position: fixed;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 3000;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 반응형 - 태블릿 이상 */
        @media (min-width: 768px) {
            .info-grid { grid-template-columns: repeat(4, 1fr); }
            .info-panel { max-width: 500px; left: 50%; transform: translateX(-50%) translateY(100%); }
            .info-panel.open { transform: translateX(-50%) translateY(0); }
            .filter-panel { max-width: 500px; left: 50%; transform: translateX(-50%) translateY(100%); }
            .filter-panel.open { transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>엘리베이터TV 설치현황</h1>
        <button class="header-btn" onclick="openFilter()" aria-label="필터">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
        </button>
    </header>

    <div class="search-bar">
        <span class="search-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </span>
        <input type="text" class="search-input" placeholder="아파트명, 주소 검색" id="searchInput">
        <button class="search-clear" id="searchClear" onclick="clearSearch()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <div id="map"></div>
    <div class="list-view" id="listView">
        <div class="list-header">
            <h3>목록 <span id="listCount">0</span>개</h3>
            <button class="list-close" onclick="toggleView()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="list-content" id="listContent"></div>
    </div>

    <div class="floating-btns">
        <button class="float-btn" onclick="toggleView()" id="viewToggle" aria-label="리스트 보기">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
        </button>
        <button class="float-btn" onclick="moveToMyLocation()" aria-label="내 위치">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"></path>
            </svg>
        </button>
    </div>

    <div class="stats-badge">
        <strong id="visibleCount">0</strong>개 표시
    </div>

    <div class="overlay" onclick="closeAllPanels()"></div>

    <div class="filter-panel" id="filterPanel">
        <div class="filter-header">
            <h2>필터</h2>
            <button class="filter-reset" onclick="resetFilter()">초기화</button>
            <button class="filter-close" onclick="closeFilter()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="filter-section">
            <h3>판매등급</h3>
            <div class="filter-chips" id="gradeFilter">
                <button class="filter-chip active" data-value="all">전체</button>
                <button class="filter-chip" data-value="S+">S+</button>
                <button class="filter-chip" data-value="S">S</button>
                <button class="filter-chip" data-value="A+">A+</button>
                <button class="filter-chip" data-value="A">A</button>
                <button class="filter-chip" data-value="B">B</button>
            </div>
        </div>
        <div class="filter-section">
            <h3>건물유형</h3>
            <div class="filter-chips" id="typeFilter">
                <button class="filter-chip active" data-value="all">전체</button>
                <button class="filter-chip" data-value="아파트">아파트</button>
                <button class="filter-chip" data-value="오피스텔">오피스텔</button>
                <button class="filter-chip" data-value="주상복합">주상복합</button>
            </div>
        </div>
        <div class="filter-section">
            <h3>지역</h3>
            <div class="filter-chips" id="guFilter">
                <button class="filter-chip active" data-value="all">전체</button>
            </div>
        </div>
        <div class="filter-section">
            <h3>설치시기</h3>
            <div class="filter-chips" id="installFilter">
                <button class="filter-chip active" data-value="all">전체</button>
                <button class="filter-chip" data-value="2025">2025년</button>
                <button class="filter-chip" data-value="2024">2024년</button>
                <button class="filter-chip" data-value="2023">2023년</button>
                <button class="filter-chip" data-value="2022">2022년</button>
                <button class="filter-chip" data-value="2021">2021년</button>
                <button class="filter-chip" data-value="2020">2020년</button>
                <button class="filter-chip" data-value="older">2019년 이전</button>
                <button class="filter-chip" data-value="none">미설치</button>
            </div>
        </div>
        <div class="filter-actions">
            <button class="filter-apply" onclick="applyFilter()">필터 적용</button>
        </div>
    </div>

    <div class="info-panel" id="infoPanel">
        <div class="info-handle"></div>
        <div class="info-content">
            <div class="info-header">
                <div class="info-name" id="infoName">-</div>
                <span class="info-grade-badge" id="infoGradeBadge">-</span>
            </div>
            <div class="info-address" id="infoAddress">-</div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">세대수</div>
                    <div class="info-value" id="infoHouseholds">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">인구수</div>
                    <div class="info-value" id="infoPopulation">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">층수</div>
                    <div class="info-value" id="infoFloors">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">평형</div>
                    <div class="info-value" id="infoArea">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">수량</div>
                    <div class="info-value" id="infoQuantity">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">대당가</div>
                    <div class="info-value" id="infoUnitPrice">-</div>
                </div>
                <div class="info-item" style="grid-column: span 2;">
                    <div class="info-label">4주 금액</div>
                    <div class="info-value" id="infoPrice" style="font-size:16px; color:#3b82f6;">-</div>
                </div>
            </div>
            <div class="info-actions">
                <button class="info-btn secondary" onclick="copyAddress()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    주소복사
                </button>
                <button class="info-btn primary" onclick="openKakaoMap()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                    </svg>
                    길찾기
                </button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">데이터 불러오는 중...</div>
    </div>

    <div class="toast" id="toast"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=40a7fdd99c590f478a37a9071c0fb69a&libraries=services&autoload=false"></script>

    <script>
        let map;
        let markers = [];
        let locations = [];
        let filteredLocations = [];
        let selectedLocation = null;
        let isListView = false;
        let geocoder;
        let currentFilters = { grade: ['all'], type: ['all'], gu: ['all'], install: ['all'], search: '' };

        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();
            kakao.maps.load(function() {
                initMap();
                initSearch();
                initFilterChips();
            });
        });

        async function loadData() {
            try {
                const response = await fetch('data.json');
                locations = await response.json();
                loadSavedCoordinates();
                filteredLocations = [...locations];

                const guSet = new Set();
                locations.forEach(loc => { if (loc.gu) guSet.add(loc.gu); });

                const guFilter = document.getElementById('guFilter');
                Array.from(guSet).sort().forEach(gu => {
                    const chip = document.createElement('button');
                    chip.className = 'filter-chip';
                    chip.dataset.value = gu;
                    chip.textContent = gu.replace(/시\s/g, '');
                    chip.onclick = () => toggleChip(chip, 'guFilter');
                    guFilter.appendChild(chip);
                });

                document.getElementById('visibleCount').textContent = locations.length.toLocaleString();
            } catch (e) {
                console.error('데이터 로드 실패:', e);
            }
        }

        function initMap() {
            document.getElementById('loadingText').textContent = '지도 불러오는 중...';
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 8
            };
            map = new kakao.maps.Map(container, options);
            geocoder = new kakao.maps.services.Geocoder();
            kakao.maps.event.addListener(map, 'click', closeInfoPanel);
            geocodeAndCreateMarkers();
        }

        async function geocodeAndCreateMarkers() {
            let processed = 0;
            let success = 0;
            const total = filteredLocations.length;

            for (let loc of filteredLocations) {
                if (loc.lat && loc.lng) {
                    createMarker(loc);
                    success++;
                    processed++;
                    continue;
                }

                await new Promise((resolve) => {
                    geocoder.addressSearch(loc.address, (result, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            loc.lat = parseFloat(result[0].y);
                            loc.lng = parseFloat(result[0].x);
                            createMarker(loc);
                            success++;
                        }
                        processed++;
                        if (processed % 100 === 0 || processed === total) {
                            document.getElementById('loadingText').textContent = `주소 변환 중... (${processed}/${total})`;
                        }
                        resolve();
                    });
                });
                await new Promise(r => setTimeout(r, 50));
            }

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('visibleCount').textContent = success.toLocaleString();
            updateListView();
            saveCoordinates();
        }

        function createMarker(loc) {
            if (!loc.lat || !loc.lng) return;
            const markerPosition = new kakao.maps.LatLng(loc.lat, loc.lng);
            const marker = new kakao.maps.Marker({
                position: markerPosition,
                map: map
            });
            kakao.maps.event.addListener(marker, 'click', function() {
                showInfo(loc);
                map.setCenter(markerPosition);
                map.setLevel(3);
            });
            markers.push({ marker, data: loc });
        }

        function saveCoordinates() {
            try {
                const coordsMap = {};
                locations.forEach(l => {
                    if (l.lat && l.lng) coordsMap[l.name] = { lat: l.lat, lng: l.lng };
                });
                localStorage.setItem('elevator_coords', JSON.stringify(coordsMap));
            } catch(e) {}
        }

        function loadSavedCoordinates() {
            try {
                const saved = localStorage.getItem('elevator_coords');
                if (saved) {
                    const coordsMap = JSON.parse(saved);
                    locations.forEach(loc => {
                        if (!loc.lat && !loc.lng && coordsMap[loc.name]) {
                            loc.lat = coordsMap[loc.name].lat;
                            loc.lng = coordsMap[loc.name].lng;
                        }
                    });
                }
            } catch(e) {}
        }

        function getGradeClass(grade) {
            if (grade === 'S+') return 's-plus';
            if (grade === 'S') return 's';
            if (grade === 'A+') return 'a-plus';
            if (grade === 'A') return 'a';
            if (grade === 'B') return 'b';
            return '';
        }

        function showInfo(loc) {
            selectedLocation = loc;
            document.getElementById('infoName').textContent = loc.name;
            document.getElementById('infoAddress').textContent = loc.address;

            const badge = document.getElementById('infoGradeBadge');
            badge.textContent = loc.grade || '-';
            badge.className = 'info-grade-badge ' + getGradeClass(loc.grade);

            document.getElementById('infoHouseholds').textContent = loc.households ? loc.households.toLocaleString() : '-';
            document.getElementById('infoPopulation').textContent = loc.population ? loc.population.toLocaleString() : '-';
            document.getElementById('infoFloors').textContent = loc.floors ? loc.floors + 'F' : '-';
            document.getElementById('infoArea').textContent = loc.area ? loc.area + '평' : '-';
            document.getElementById('infoQuantity').textContent = loc.quantity ? loc.quantity + '대' : '-';
            document.getElementById('infoUnitPrice').textContent = loc.unit_price ? loc.unit_price.toLocaleString() : '-';
            document.getElementById('infoPrice').textContent = loc.price_4w ? loc.price_4w.toLocaleString() + '원' : '-';

            document.getElementById('infoPanel').classList.add('open');
            document.querySelector('.overlay').classList.add('active');
        }

        function initSearch() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('searchClear');
            let timer;

            input.addEventListener('input', function() {
                clearBtn.classList.toggle('show', this.value.length > 0);
                clearTimeout(timer);
                timer = setTimeout(() => {
                    currentFilters.search = this.value.toLowerCase();
                    applyFilterLogic();
                }, 300);
            });
        }

        function clearSearch() {
            const input = document.getElementById('searchInput');
            input.value = '';
            document.getElementById('searchClear').classList.remove('show');
            currentFilters.search = '';
            applyFilterLogic();
            input.focus();
        }

        function initFilterChips() {
            document.querySelectorAll('.filter-chips').forEach(container => {
                container.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.onclick = () => toggleChip(chip, container.id);
                });
            });
        }

        function toggleChip(chip, containerId) {
            const container = document.getElementById(containerId);
            const allChip = container.querySelector('[data-value="all"]');
            const isAll = chip.dataset.value === 'all';

            if (isAll) {
                // "전체" 클릭 시 다른 선택 해제
                container.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
            } else {
                // 다른 항목 클릭 시
                allChip.classList.remove('active');
                chip.classList.toggle('active');

                // 아무것도 선택 안되면 "전체" 활성화
                const activeChips = container.querySelectorAll('.filter-chip.active');
                if (activeChips.length === 0) {
                    allChip.classList.add('active');
                }
            }
        }

        function resetFilter() {
            document.querySelectorAll('.filter-chips').forEach(container => {
                container.querySelectorAll('.filter-chip').forEach((c, i) => {
                    c.classList.toggle('active', i === 0);
                });
            });
        }

        function getSelectedValues(containerId) {
            const chips = document.querySelectorAll(`#${containerId} .filter-chip.active`);
            return Array.from(chips).map(c => c.dataset.value);
        }

        function applyFilter() {
            currentFilters.grade = getSelectedValues('gradeFilter');
            currentFilters.type = getSelectedValues('typeFilter');
            currentFilters.gu = getSelectedValues('guFilter');
            currentFilters.install = getSelectedValues('installFilter');
            applyFilterLogic();
            closeFilter();
        }

        function applyFilterLogic() {
            markers.forEach(m => m.marker.setMap(null));
            markers = [];

            filteredLocations = locations.filter(d => {
                // 등급 필터 (다중 선택)
                if (!currentFilters.grade.includes('all') && !currentFilters.grade.includes(d.grade)) return false;

                // 건물유형 필터 (다중 선택)
                if (!currentFilters.type.includes('all') && !currentFilters.type.includes(d.building_type)) return false;

                // 지역 필터 (다중 선택)
                if (!currentFilters.gu.includes('all') && !currentFilters.gu.includes(d.gu)) return false;

                // 설치시기 필터 (다중 선택)
                if (!currentFilters.install.includes('all')) {
                    const installDate = d.install_date || '';
                    const year = installDate.substring(0, 4);
                    let matched = false;

                    for (const filter of currentFilters.install) {
                        if (filter === 'none' && !installDate) { matched = true; break; }
                        if (filter === 'older' && installDate && parseInt(year) < 2020) { matched = true; break; }
                        if (year === filter) { matched = true; break; }
                    }
                    if (!matched) return false;
                }

                // 검색어 필터
                if (currentFilters.search) {
                    const s = currentFilters.search;
                    if (!(d.name?.toLowerCase().includes(s) || d.address?.toLowerCase().includes(s) || d.dong?.toLowerCase().includes(s))) return false;
                }
                return true;
            });

            let mapCount = 0;
            let firstLoc = null;
            filteredLocations.forEach(loc => {
                if (loc.lat && loc.lng) {
                    createMarker(loc);
                    if (!firstLoc) firstLoc = loc;
                    mapCount++;
                }
            });

            // 필터된 결과가 있으면 모든 마커가 보이도록 지도 범위 조정
            if (firstLoc && !currentFilters.gu.includes('all')) {
                const bounds = new kakao.maps.LatLngBounds();
                filteredLocations.forEach(loc => {
                    if (loc.lat && loc.lng) {
                        bounds.extend(new kakao.maps.LatLng(loc.lat, loc.lng));
                    }
                });
                map.setBounds(bounds);
            }

            document.getElementById('visibleCount').textContent = mapCount.toLocaleString();
            updateListView();
        }

        function updateListView() {
            const listContent = document.getElementById('listContent');
            listContent.innerHTML = '';
            document.getElementById('listCount').textContent = filteredLocations.length.toLocaleString();

            filteredLocations.forEach(loc => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.onclick = () => {
                    showInfo(loc);
                    if (loc.lat && loc.lng) {
                        map.setCenter(new kakao.maps.LatLng(loc.lat, loc.lng));
                        map.setLevel(3);
                    }
                    if (isListView) toggleView();
                };

                item.innerHTML = `
                    <div class="list-item-header">
                        <span class="list-item-name">${loc.name}</span>
                        <span class="grade-badge ${getGradeClass(loc.grade)}">${loc.grade || '-'}</span>
                    </div>
                    <div class="list-item-address">${loc.address}</div>
                    <div class="list-item-info">
                        <span>세대수 <strong>${loc.households?.toLocaleString() || '-'}</strong></span>
                        <span>4주 <strong>${loc.price_4w?.toLocaleString() || '-'}원</strong></span>
                    </div>
                `;
                listContent.appendChild(item);
            });
        }

        function toggleView() {
            isListView = !isListView;
            document.getElementById('listView').classList.toggle('active', isListView);
            document.getElementById('viewToggle').classList.toggle('active', isListView);
        }

        function moveToMyLocation() {
            if (navigator.geolocation) {
                showToast('위치를 찾는 중...');
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const moveLatLng = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                        map.setCenter(moveLatLng);
                        map.setLevel(4);
                        showToast('현재 위치로 이동했습니다');
                    },
                    () => showToast('위치를 가져올 수 없습니다')
                );
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function copyAddress() {
            if (selectedLocation) {
                navigator.clipboard.writeText(selectedLocation.address);
                showToast('주소가 복사되었습니다');
            }
        }

        function openKakaoMap() {
            if (selectedLocation) {
                const addr = encodeURIComponent(selectedLocation.address);
                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                    window.location.href = `kakaomap://search?q=${addr}`;
                    setTimeout(() => {
                        window.open(`https://map.kakao.com/link/search/${addr}`, '_blank');
                    }, 1000);
                } else {
                    window.open(`https://map.kakao.com/link/search/${addr}`, '_blank');
                }
            }
        }

        function openFilter() {
            document.getElementById('filterPanel').classList.add('open');
            document.querySelector('.overlay').classList.add('active');
        }

        function closeFilter() {
            document.getElementById('filterPanel').classList.remove('open');
            document.querySelector('.overlay').classList.remove('active');
        }

        function closeInfoPanel() {
            document.getElementById('infoPanel').classList.remove('open');
            document.querySelector('.overlay').classList.remove('active');
        }

        function closeAllPanels() {
            closeFilter();
            closeInfoPanel();
        }
    </script>
</body>
</html>
