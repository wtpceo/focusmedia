<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>엘리베이터TV 설치현황</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
        }
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 56px;
            background: #fff;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            gap: 12px;
        }
        .header h1 { font-size: 18px; font-weight: 600; color: #333; flex: 1; }
        .header-btn {
            width: 40px; height: 40px;
            border: none;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }
        .search-bar {
            position: fixed;
            top: 64px; left: 12px; right: 12px;
            z-index: 1000;
        }
        .search-input {
            width: 100%;
            height: 44px;
            padding: 0 16px 0 44px;
            border: none;
            border-radius: 22px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 15px;
            outline: none;
        }
        .search-icon {
            position: absolute;
            left: 16px; top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #999;
        }
        #map {
            width: 100%;
            height: 100vh;
            height: 100dvh;
        }
        .filter-panel {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            max-height: 70vh;
            overflow-y: auto;
        }
        .filter-panel.open { transform: translateY(0); }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            position: sticky; top: 0;
            background: #fff;
        }
        .filter-header h2 { font-size: 18px; }
        .filter-close {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }
        .filter-section {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .filter-section h3 { font-size: 14px; color: #666; margin-bottom: 12px; }
        .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        .filter-chip.active {
            background: #FEE500;
            color: #000;
            border-color: #FEE500;
        }
        .filter-apply {
            margin: 20px;
            width: calc(100% - 40px);
            padding: 16px;
            background: #FEE500;
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .info-panel {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        .info-panel.open { transform: translateY(0); }
        .info-handle {
            width: 40px; height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 0 auto 16px;
        }
        .info-name { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #333; }
        .info-address { font-size: 14px; color: #666; margin-bottom: 16px; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .info-item { background: #f8f9fa; padding: 12px; border-radius: 12px; }
        .info-label { font-size: 12px; color: #999; margin-bottom: 4px; }
        .info-value { font-size: 16px; font-weight: 600; color: #333; }
        .info-value.grade-a-plus { color: #e74c3c; }
        .info-value.grade-a { color: #3498db; }
        .info-value.grade-b { color: #27ae60; }
        .info-actions { display: flex; gap: 12px; }
        .info-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        .info-btn.primary { background: #FEE500; color: #000; }
        .info-btn.secondary { background: #f0f0f0; color: #333; }
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 999;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .location-btn {
            position: fixed;
            right: 16px; bottom: 100px;
            width: 48px; height: 48px;
            background: #fff;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 22px;
            z-index: 500;
        }
        .stats-badge {
            position: fixed;
            left: 16px; bottom: 100px;
            background: #fff;
            padding: 8px 14px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 13px;
            z-index: 500;
        }
        .stats-badge strong { color: #3396FF; }
        .loading {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 24px 32px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 2000;
        }
        .loading.hidden { display: none; }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid #f0f0f0;
            border-top-color: #FEE500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .list-view {
            position: fixed;
            top: 120px; left: 12px; right: 12px; bottom: 80px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow-y: auto;
            z-index: 800;
            display: none;
        }
        .list-view.active { display: block; }
        .list-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .list-item:active { background: #f8f8f8; }
        .list-item-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .list-item-address { font-size: 13px; color: #666; margin-bottom: 8px; }
        .list-item-info { display: flex; gap: 12px; font-size: 13px; }
        .list-item-info span { color: #999; }
        .list-item-info strong { color: #333; }
        .grade-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .grade-badge.a-plus { background: #fde8e8; color: #e74c3c; }
        .grade-badge.a { background: #e8f4fd; color: #3498db; }
        .grade-badge.b { background: #e8fdf0; color: #27ae60; }
        .view-toggle {
            position: fixed;
            right: 16px; bottom: 160px;
            width: 48px; height: 48px;
            background: #fff;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 20px;
            z-index: 500;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>엘리베이터TV 설치현황</h1>
        <button class="header-btn" onclick="openFilter()">&#9776;</button>
    </header>

    <div class="search-bar">
        <span class="search-icon">&#128269;</span>
        <input type="text" class="search-input" placeholder="아파트명, 주소 검색..." id="searchInput">
    </div>

    <div id="map"></div>
    <div class="list-view" id="listView"></div>

    <button class="view-toggle" onclick="toggleView()" id="viewToggle">&#128203;</button>
    <button class="location-btn" onclick="moveToMyLocation()">&#128205;</button>

    <div class="stats-badge">총: <strong id="visibleCount">0</strong>개</div>

    <div class="overlay" onclick="closeAllPanels()"></div>

    <div class="filter-panel" id="filterPanel">
        <div class="filter-header">
            <h2>필터</h2>
            <button class="filter-close" onclick="closeFilter()">&times;</button>
        </div>
        <div class="filter-section">
            <h3>판매등급</h3>
            <div class="filter-chips" id="gradeFilter">
                <button class="filter-chip active" data-value="all">전체</button>
                <button class="filter-chip" data-value="A+">A+</button>
                <button class="filter-chip" data-value="A">A</button>
                <button class="filter-chip" data-value="B">B</button>
            </div>
        </div>
        <div class="filter-section">
            <h3>건물유형</h3>
            <div class="filter-chips" id="typeFilter">
                <button class="filter-chip active" data-value="all">전체</button>
                <button class="filter-chip" data-value="아파트">아파트</button>
                <button class="filter-chip" data-value="오피스텔">오피스텔</button>
                <button class="filter-chip" data-value="주상복합">주상복합</button>
            </div>
        </div>
        <div class="filter-section">
            <h3>지역</h3>
            <div class="filter-chips" id="guFilter">
                <button class="filter-chip active" data-value="all">전체</button>
            </div>
        </div>
        <button class="filter-apply" onclick="applyFilter()">필터 적용</button>
    </div>

    <div class="info-panel" id="infoPanel">
        <div class="info-handle"></div>
        <div class="info-name" id="infoName">-</div>
        <div class="info-address" id="infoAddress">-</div>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">판매등급</div>
                <div class="info-value" id="infoGrade">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">총 세대수</div>
                <div class="info-value" id="infoHouseholds">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">총 인구수</div>
                <div class="info-value" id="infoPopulation">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">건물층수</div>
                <div class="info-value" id="infoFloors">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">기준평형</div>
                <div class="info-value" id="infoArea">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">판매수량</div>
                <div class="info-value" id="infoQuantity">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">대당가격</div>
                <div class="info-value" id="infoUnitPrice">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">4주 금액</div>
                <div class="info-value" id="infoPrice">-</div>
            </div>
        </div>
        <div class="info-actions">
            <button class="info-btn secondary" onclick="copyAddress()">&#128203; 주소복사</button>
            <button class="info-btn primary" onclick="openKakaoMap()">&#128506; 길찾기</button>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div id="loadingText">데이터 불러오는 중...</div>
    </div>

    <!-- 카카오맵 API (autoload=false로 직접 로드 제어) -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=40a7fdd99c590f478a37a9071c0fb69a&libraries=services&autoload=false"></script>

    <script>
        let map;
        let markers = [];
        let locations = [];
        let filteredLocations = [];
        let selectedLocation = null;
        let isListView = false;
        let geocoder;
        let currentFilters = { grade: 'all', type: 'all', gu: 'all', search: '' };

        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();

            // 카카오맵 SDK 로드 완료 후 초기화
            kakao.maps.load(function() {
                initMap();
                initSearch();
                initFilterChips();
            });
        });

        async function loadData() {
            try {
                const response = await fetch('data.json');
                locations = await response.json();

                // 저장된 좌표 먼저 적용
                loadSavedCoordinates();

                filteredLocations = [...locations];

                const withCoords = locations.filter(l => l.lat && l.lng).length;
                console.log(`총 ${locations.length}개, 좌표: ${withCoords}개`);

                const guSet = new Set();
                locations.forEach(loc => { if (loc.gu) guSet.add(loc.gu); });

                const guFilter = document.getElementById('guFilter');
                Array.from(guSet).sort().forEach(gu => {
                    const chip = document.createElement('button');
                    chip.className = 'filter-chip';
                    chip.dataset.value = gu;
                    chip.textContent = gu.replace(/시\s/g, '');
                    chip.onclick = () => toggleChip(chip, 'guFilter');
                    guFilter.appendChild(chip);
                });

                document.getElementById('visibleCount').textContent = locations.length;
            } catch (e) {
                console.error('데이터 로드 실패:', e);
            }
        }

        function initMap() {
            document.getElementById('loadingText').textContent = '지도 불러오는 중...';

            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 8
            };

            map = new kakao.maps.Map(container, options);
            geocoder = new kakao.maps.services.Geocoder();

            // 지도 클릭 시 정보 패널 닫기
            kakao.maps.event.addListener(map, 'click', closeInfoPanel);

            // 좌표 변환 및 마커 생성
            geocodeAndCreateMarkers();
        }

        async function geocodeAndCreateMarkers() {
            let processed = 0;
            let success = 0;
            const total = filteredLocations.length;

            for (let loc of filteredLocations) {
                // 이미 좌표가 있으면 바로 마커 생성
                if (loc.lat && loc.lng) {
                    createMarker(loc);
                    success++;
                    processed++;
                    continue;
                }

                // 좌표가 없으면 지오코딩
                await new Promise((resolve) => {
                    geocoder.addressSearch(loc.address, (result, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            loc.lat = parseFloat(result[0].y);
                            loc.lng = parseFloat(result[0].x);
                            createMarker(loc);
                            success++;
                        }
                        processed++;

                        if (processed % 100 === 0 || processed === total) {
                            document.getElementById('loadingText').textContent =
                                `주소 변환 중... (${processed}/${total})`;
                            document.getElementById('visibleCount').textContent =
                                `${total}개 (지도: ${success})`;
                        }

                        resolve();
                    });
                });

                // API 제한 방지
                await new Promise(r => setTimeout(r, 50));
            }

            document.getElementById('loading').classList.add('hidden');
            updateListView();

            // 변환된 좌표 저장 (다음에 빠르게 로드)
            saveCoordinates();
        }

        function createMarker(loc) {
            if (!loc.lat || !loc.lng) return;

            let markerColor = '#3396FF';
            if (loc.grade === 'A+') markerColor = '#e74c3c';
            else if (loc.grade === 'A') markerColor = '#3498db';
            else if (loc.grade === 'B') markerColor = '#27ae60';

            const markerPosition = new kakao.maps.LatLng(loc.lat, loc.lng);

            const marker = new kakao.maps.Marker({
                position: markerPosition,
                map: map
            });

            kakao.maps.event.addListener(marker, 'click', function() {
                showInfo(loc);
                map.setCenter(markerPosition);
                map.setLevel(3);
            });

            markers.push({ marker, data: loc });
        }

        function saveCoordinates() {
            // 로컬스토리지에 좌표 저장 (다음 로드시 빠르게)
            try {
                const coordsMap = {};
                locations.forEach(l => {
                    if (l.lat && l.lng) {
                        coordsMap[l.name] = { lat: l.lat, lng: l.lng };
                    }
                });
                localStorage.setItem('elevator_coords', JSON.stringify(coordsMap));
                console.log('좌표 저장 완료:', Object.keys(coordsMap).length + '개');
            } catch(e) {
                console.error('좌표 저장 실패:', e);
            }
        }

        function loadSavedCoordinates() {
            try {
                const saved = localStorage.getItem('elevator_coords');
                if (saved) {
                    const coordsMap = JSON.parse(saved);
                    let applied = 0;
                    locations.forEach(loc => {
                        if (!loc.lat && !loc.lng && coordsMap[loc.name]) {
                            loc.lat = coordsMap[loc.name].lat;
                            loc.lng = coordsMap[loc.name].lng;
                            applied++;
                        }
                    });
                    console.log('저장된 좌표 적용:', applied + '개');
                    return applied;
                }
            } catch(e) {}
            return 0;
        }

        function showInfo(loc) {
            selectedLocation = loc;
            document.getElementById('infoName').textContent = loc.name;
            document.getElementById('infoAddress').textContent = loc.address;

            const gradeEl = document.getElementById('infoGrade');
            gradeEl.textContent = loc.grade || '-';
            gradeEl.className = 'info-value';
            if (loc.grade === 'A+') gradeEl.classList.add('grade-a-plus');
            else if (loc.grade === 'A') gradeEl.classList.add('grade-a');
            else if (loc.grade === 'B') gradeEl.classList.add('grade-b');

            document.getElementById('infoHouseholds').textContent = loc.households ? loc.households.toLocaleString() + '세대' : '-';
            document.getElementById('infoPopulation').textContent = loc.population ? loc.population.toLocaleString() + '명' : '-';
            document.getElementById('infoFloors').textContent = loc.floors ? loc.floors + '층' : '-';
            document.getElementById('infoArea').textContent = loc.area ? loc.area + '평' : '-';
            document.getElementById('infoQuantity').textContent = loc.quantity ? loc.quantity + '대' : '-';
            document.getElementById('infoUnitPrice').textContent = loc.unit_price ? loc.unit_price.toLocaleString() + '원' : '-';
            document.getElementById('infoPrice').textContent = loc.price_4w ? loc.price_4w.toLocaleString() + '원' : '-';

            document.getElementById('infoPanel').classList.add('open');
            document.querySelector('.overlay').classList.add('active');
        }

        function initSearch() {
            const input = document.getElementById('searchInput');
            let timer;
            input.addEventListener('input', function() {
                clearTimeout(timer);
                timer = setTimeout(() => {
                    currentFilters.search = this.value.toLowerCase();
                    applyFilterLogic();
                }, 300);
            });
        }

        function initFilterChips() {
            document.querySelectorAll('.filter-chips').forEach(container => {
                container.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.onclick = () => toggleChip(chip, container.id);
                });
            });
        }

        function toggleChip(chip, containerId) {
            document.getElementById(containerId).querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
        }

        function applyFilter() {
            currentFilters.grade = document.querySelector('#gradeFilter .active').dataset.value;
            currentFilters.type = document.querySelector('#typeFilter .active').dataset.value;
            currentFilters.gu = document.querySelector('#guFilter .active').dataset.value;
            applyFilterLogic();
            closeFilter();
        }

        function applyFilterLogic() {
            // 기존 마커 제거
            markers.forEach(m => m.marker.setMap(null));
            markers = [];

            filteredLocations = locations.filter(d => {
                if (currentFilters.grade !== 'all' && d.grade !== currentFilters.grade) return false;
                if (currentFilters.type !== 'all' && d.building_type !== currentFilters.type) return false;
                if (currentFilters.gu !== 'all' && d.gu !== currentFilters.gu) return false;
                if (currentFilters.search) {
                    const s = currentFilters.search;
                    if (!(d.name?.toLowerCase().includes(s) || d.address?.toLowerCase().includes(s) || d.dong?.toLowerCase().includes(s))) return false;
                }
                return true;
            });

            // 마커 다시 생성
            let mapCount = 0;
            filteredLocations.forEach(loc => {
                if (loc.lat && loc.lng) {
                    createMarker(loc);
                    mapCount++;
                }
            });

            document.getElementById('visibleCount').textContent =
                `${filteredLocations.length}개 (지도: ${mapCount})`;
            updateListView();
        }

        function updateListView() {
            const listView = document.getElementById('listView');
            listView.innerHTML = '';

            filteredLocations.forEach(loc => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.onclick = () => {
                    showInfo(loc);
                    if (loc.lat && loc.lng) {
                        map.setCenter(new kakao.maps.LatLng(loc.lat, loc.lng));
                        map.setLevel(3);
                    }
                    if (isListView) toggleView();
                };

                let badge = '';
                if (loc.grade === 'A+') badge = 'a-plus';
                else if (loc.grade === 'A') badge = 'a';
                else if (loc.grade === 'B') badge = 'b';

                item.innerHTML = `
                    <div class="list-item-name">${loc.name}<span class="grade-badge ${badge}">${loc.grade || '-'}</span></div>
                    <div class="list-item-address">${loc.address}</div>
                    <div class="list-item-info">
                        <span>세대수: <strong>${loc.households?.toLocaleString() || '-'}</strong></span>
                        <span>4주금액: <strong>${loc.price_4w?.toLocaleString() || '-'}원</strong></span>
                    </div>
                `;
                listView.appendChild(item);
            });
        }

        function toggleView() {
            isListView = !isListView;
            document.getElementById('listView').classList.toggle('active', isListView);
            document.getElementById('viewToggle').innerHTML = isListView ? '&#128506;' : '&#128203;';
        }

        function moveToMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const moveLatLng = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                        map.setCenter(moveLatLng);
                        map.setLevel(4);
                    },
                    () => alert('위치를 가져올 수 없습니다.')
                );
            }
        }

        function copyAddress() {
            if (selectedLocation) {
                navigator.clipboard.writeText(selectedLocation.address);
                alert('주소가 복사되었습니다.');
            }
        }

        function openKakaoMap() {
            if (selectedLocation) {
                const addr = encodeURIComponent(selectedLocation.address);
                const name = encodeURIComponent(selectedLocation.name);

                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                    // 카카오맵 앱으로 열기
                    window.location.href = `kakaomap://search?q=${addr}`;
                    setTimeout(() => {
                        window.open(`https://map.kakao.com/link/search/${addr}`, '_blank');
                    }, 1000);
                } else {
                    window.open(`https://map.kakao.com/link/search/${addr}`, '_blank');
                }
            }
        }

        function openFilter() {
            document.getElementById('filterPanel').classList.add('open');
            document.querySelector('.overlay').classList.add('active');
        }

        function closeFilter() {
            document.getElementById('filterPanel').classList.remove('open');
            document.querySelector('.overlay').classList.remove('active');
        }

        function closeInfoPanel() {
            document.getElementById('infoPanel').classList.remove('open');
            document.querySelector('.overlay').classList.remove('active');
        }

        function closeAllPanels() {
            closeFilter();
            closeInfoPanel();
        }
    </script>
</body>
</html>
